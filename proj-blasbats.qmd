```{r setup}
#| include: false
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(tidyverse)
```

# B. Lasbats {.unnumbered}

*Description.*

## Climate

```{r climdata}
#| message: false
path <- "~/Documents/data/blasbats/"
projs <- readRDS(file.path(path, "231017_climate_scenarios_2071-2100.rds")) %>% 
  lapply(bind_rows, .id = "scenario") %>% 
  bind_rows(.id = "model") %>% 
  mutate(period = "2071-2100") %>% 
  gather(variable, value, -model, -scenario, -clus, -type, -period) %>% 
  mutate(variable = recode(variable,
                           "Prec (kg/m2/month)" = "pr",
                           "T_mean (°C)" = "bio1",
                           "T_min (°C)" = "tas_min",       
                           "T_max (°C)" = "tas_max",
                           "T_seas (°C/100)" = "bio4",
                           "Rainfall_year (kg/m2/year)" = "bio12",
                           "Rainfall_seas (kg/m2)" = "bio15",
                           "Sol_rad..MJ.m2.day." = "srad")) %>% 
  mutate(type = as.numeric(type))

current <- read_csv(file.path(path, "clim_data.csv")) %>% 
  select(-`...1`) %>% 
  mutate(model = "data", scenario = "current", period = "current") %>% 
  gather(variable, value, -model, -scenario, -clus, -type, -period) %>% 
  mutate(variable = recode(variable,
                           "P.EvapoT (kg/m2/month)" = "pet",
                           "Prec (kg/m2/month)" = "pr",   
                           "T_mean (°C)"  = "bio1",             
                           "T_min (°C)" = "tas_min",            
                           "T_max (°C)" = "tas_max",
                           "Sol_rad (MJ/m2/day)" = "srad",       
                           "T_seas (°C/100)" = "bio4",          
                           "Rainfall_year (kg/m2/year)"  = "bio12",
                           "Rainfall_seas (kg/m2)" = "bio15"))

climate <- bind_rows(current, projs) %>% 
  mutate(var_long = recode(variable,
                           "pet" = "Potential Evapotranspiration",
                           "pr" = "Precipitation", 
                           "bio1" = "Annual Mean Temperature",
                           "tas_min" = "Annual Minimum Temperature",
                           "tas_max" = "Annual Maximum Temperature",
                           "srad" = "Solar Radiation",  
                           "bio4" = "Temperature Seasonality",  
                           "bio12" = "Annual Precipitation",
                           "bio15" = "Precipitation Seasonality")) %>% 
  mutate(unit = recode(variable,
                           "pet" = "kg/m2/month",
                           "pr" = "kg/m2/month", 
                           "bio1" = "°C",
                           "tas_min" = "°C",
                           "tas_max" = "°C",
                           "srad" = "MJ/m2/day",  
                           "bio4" = "100°C",  
                           "bio12" = "kg/m2/year",
                           "bio15" = "kg/m2"))
```

```{r}
climate %>% 
  filter(variable != "pet") %>% 
  ggplot(aes(model, value, 
             col = scenario, fill = (model == "GFDL-ESM4"))) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_x") +
  theme_bw() +
  coord_flip() +
  scale_color_discrete("") +
  theme(legend.position = "bottom", axis.title = element_blank()) +
  scale_fill_manual(guide = "none", values = c("NA", "yellow"))
```

> -   What is the difference between "Rainfall_year (kg/m2/year)" (bio12) and "Prec (kg/m2/month)" (pr)?
> -   Are "T_min (°C)" (tas_min) and "T_max (°C)" (tas_max) annual extrema or computed for warmest and coldest month or quarter (as bioclimatic variables)?

```{r}
climate %>% 
  filter(!(variable %in% c("pet", "srad", "pr"))) %>% 
  filter(scenario %in% c("current", "+4.4°C")) %>% 
  ggplot(aes(model, value, 
             col = scenario, fill = (model == "GFDL-ESM4"))) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_x") +
  theme_bw() +
  coord_flip() +
  scale_color_discrete("") +
  theme(legend.position = "bottom", axis.title = element_blank()) +
  scale_fill_manual(guide = "none", values = c("NA", "yellow"))
```

> GFDL-ESM4 is stronger for bio12 (Annual Precipitation), bio15 (Precipitation Seasonality) and bio4 (Temperature Seasonality).

```{r}
climate %>% 
  filter(variable %in% c("bio12")) %>% 
  filter(scenario %in% c("current", "+4.4°C")) %>% 
  ggplot(aes(model, value/10^3, 
             col = scenario, fill = (model == "GFDL-ESM4"))) +
  geom_boxplot() +
  facet_wrap(~ clus) +
  theme_bw() +
  coord_flip() +
  scale_color_discrete(guide = "none") +
  theme(legend.position = "bottom", axis.title = element_blank()) +
  ggtitle("BIO12 (Annual Precipitation, m)") +
  scale_fill_manual(guide = "none", values = c("NA", "yellow"))
```

```{r}
climate %>% 
  filter(variable %in% c("bio15")) %>% 
  filter(scenario %in% c("current", "+4.4°C")) %>% 
  ggplot(aes(model, value, 
             col = scenario, fill = (model == "GFDL-ESM4"))) +
  geom_boxplot() +
  facet_wrap(~ clus) +
  theme_bw() +
  coord_flip() +
  scale_color_discrete(guide = "none") +
  theme(legend.position = "bottom", axis.title = element_blank()) +
  ggtitle("BIO15 (Precipitation Seasonality)") +
  scale_fill_manual(guide = "none", values = c("NA", "yellow"))
```

```{r}
climate %>% 
  filter(variable %in% c("bio4")) %>% 
  filter(scenario %in% c("current", "+4.4°C")) %>% 
  ggplot(aes(model, value, 
             col = scenario, fill = (model == "GFDL-ESM4"))) +
  geom_boxplot() +
  facet_wrap(~ clus) +
  theme_bw() +
  coord_flip() +
  scale_color_discrete(guide = "none") +
  theme(legend.position = "bottom", axis.title = element_blank()) +
  ggtitle("BIO4 (Temperature Seasonality)") +
  scale_fill_manual(guide = "none", values = c("NA", "yellow"))
```

> Not sure, to be explored in climate weights, but it seems that GFDL-ESM4 shows extreme values in cluster for BIO4 (Temperature Seasonality), that could results in the observed discrepancies.

## Trees

```{r treedata}
path <- "~/Documents/data/blasbats/"
wsg <- readRDS(file.path(path, "treeDB.RDS")) %>% 
  mutate(species = paste(genus, species)) %>% 
  group_by(species) %>% 
  summarise(wsg = mean(WDmean))
wsg_quantiles <- data.frame(quantile = c(0.05, 0.25, 0.5, 0.75, 0.95)) %>% 
  expand_grid(wsg) %>% 
  group_by(quantile) %>% 
  summarise(wsg = unique(quantile(wsg, probs = quantile)))
```

```{r}
#| message: false
ggplot(wsg, aes(wsg)) +
  geom_histogram() +
  theme_bw() +
  xlab("Wood Specific Gravity") + ylab("") +
  geom_vline(data = wsg_quantiles, aes(xintercept = wsg), col= "red")
```

## Parameters

```{r fitdata}
path <- "~/Documents/data/blasbats/"
n <- 10^3
fit <- readRDS(file.path(path, "231009_fit5Vars_WDclim.RDS"))$chains %>% 
  mutate(iter = 1:n()) %>% 
  sample_n(n) %>% 
  gather(parameter, value, -iter) %>% 
  filter(grepl('theta_clim', parameter))
```

```{r}
#| message: false
ggplot(fit, aes(value)) +
  geom_histogram() +
  facet_wrap(~ parameter) +
  theme_bw() +
  theme(axis.title = element_blank()) +
  geom_vline(xintercept = 0, col = "red", linewidth = 1.2)
```

## Assembly

```{r}
#| eval: false
clim_fit <- climate %>% 
  filter(variable %in% c("pr", "tas_max", "srad", "bio15", "bio4")) %>% 
  select(-unit, -var_long) %>% 
  pivot_wider(names_from = variable, values_from = value)
all <- fit %>% 
  pivot_wider(names_from = parameter, values_from = value) %>% 
  expand_grid(clim_fit) %>% 
  expand_grid(wsg_quantiles)
```
